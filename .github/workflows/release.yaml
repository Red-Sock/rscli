name: master-actions
run-name: RELEASE
on:
  pull_request_target:
    branches:
      - main

env:
  PATTERN_MK_FILE_PTH: plugins/project/processor/patterns/pattern/rscli.mk

jobs:
  tag-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Obtaining current release tag
        id: release
        run: |
          # obtaining latest stable release
          latestRelease=$(gh release list \
            -R https://github.com/Red-Sock/rscli \
            --exclude-drafts \
            --exclude-pre-releases \
            -L 1)
          
          # predefined variable for splitting strings
          IFS='	'
          
          read -a latestReleaseArr <<< "$latestRelease"
          
          echo "tag=${latestReleaseArr[0]}" >> $GITHUB_OUTPUT
          echo "latest github release is ${latestReleaseArr[0]}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Obtaining tag from pattern
        id: project
        run: |
          tagFromPattern=`head -n 1 $PATTERN_MK_FILE_PTH`
          
          IFS='='
          read -a patternTagArr <<< "$tagFromPattern"
          
          echo "Current pattern tag is ${patternTagArr[1]}"
          echo "tag=${patternTagArr[1]}" >> $GITHUB_OUTPUT

      - name: Validating tag
        run: |
          echo "Latest release: ${{ steps.release.outputs.tag }}"
          echo "Project tag: ${{ steps.project.outputs.tag }}"
          
          if [[ "${{ steps.release.outputs.tag }}" == "${{ steps.project.outputs.tag }}" ]]; then
              echo "
                  Release tags are equal.
                  Update rscli version in $PATTERN_MK_FILE_PTH
                  before creating release 
                  and recompile project-pattern
          "
              # TODO add comment to git pr
              exit 1
          fi